---
title: "normalization"
author: "Sascha Maschmann"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DESeq2)
```

## Normalization of sRNA seq reads
Reads will be normalized with size factors calculated from features located outside the mitochondria with stable detection rates throughout the experiment.  
The broad idea is:  

- QC of features
- CPM normalize candidates
- Calculate L2FC for all genes
- Filter for genes that don't change with the perturbations
- select the center 80% of features
- Estimate size factors through DESeq2
- Use size factors for mito read normalization

#TODO - adapt file paths!

```{r load decoy count data}
decoyCountFiles <- list.files("../out/counts",
                        pattern = "*decoy.unique.featureCounts.txt$",
                        full.names = TRUE)

decoyCounts <- read.delim(decoyCountFiles[1], header = T, skip = 1) %>% 
  select(Geneid, last_col())
for (file in decoyCountFiles[2:length(decoyCountFiles)]){
  counts <- read.delim(file, header = T, skip = 1) %>% 
    select(Geneid, last_col())
  decoyCounts <- left_join(decoyCounts, counts, by = "Geneid")
}

# Filter out all genes with less than 10 reads in any sample
cleanDecoyCounts <- decoyCounts %>% 
  filter(if_all(-Geneid, ~ .x >= 10))
  
```

## Investigate stable genes  
Based on a simple, preliminary normalization and subsequent calculation of log2 fold changes, stable genes are selected from the decoy dataset: lowest 60% of absolute LFCs. alternatively filter by absolute values, depending on numbers.
```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
